# Ceny Towarów i Usług - Łukasz Wasak

Dane pobrane z [GUS](http://www.stat.gov.pl/bdl/app/strona.html?p_name=indeks), użyto 32 zestawów danych:

## Towary nie kompsumcyjne
* [DP_20130306_142707.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_142707.csv)
* [DP_20130306_142807.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_142807.csv)
* [DP_20130306_142852.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_142852.csv)
* [DP_20130306_143019.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_143019.csv)

## Rolnictwo
* [DP_20130306_145335.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145335.csv)
* [DP_20130306_145426.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145426.csv)
* [DP_20130306_145526.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145526.csv)
* [DP_20130306_145607.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145607.csv)

## Towary spożywcze

### Przetwory
* [DP_20130306_133022.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/przetwory/DP_20130306_133022.csv)

### Tłuszcze i nabiał
* [DP_20130306_132715.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/t%C5%82uszcze%20i%20nabia%C5%82/DP_20130306_132715.csv)
* [DP_20130306_132715.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/t%C5%82uszcze%20i%20nabia%C5%82/DP_20130306_132715.csv)

### Wyroby mięsne
* [DP_20130306_133300.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/miesne/DP_20130306_133300.csv)
* [DP_20130306_133435.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/miesne/DP_20130306_133435.csv)

### Zbożowe
* [DP_20130306_133826.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/zbozowe/DP_20130306_133826.csv)

### Pozostałe
* [DP_20130306_133619.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/zbozowe/DP_20130306_133619.csv)

## Towary i usługi kompsumcyjne
### Mieszkanie
* [DP_20130306_143621.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/mieszkanie/DP_20130306_143621.csv)
* [DP_20130306_143713.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/mieszkanie/DP_20130306_143713.csv)
* [DP_20130306_143756.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/mieszkanie/DP_20130306_143756.csv)

### Napoje alkoholowe i tytoń
* [DP_20130306_143908.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/napoje%20alkoholowe%20i%20tyton/DP_20130306_143908.csv)

### Odzież i obuwie
* [DP_20130306_144042.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/odziez%20i%20obuwie/DP_20130306_144042.csv)
* [DP_20130306_144145.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/odziez%20i%20obuwie/DP_20130306_144145.csv)

### Rekreacja i kultura
* [DP_20130306_144249.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/rekreacja%20i%20kultura/DP_20130306_144249.csv)

### Transport
* [DP_20130306_144352.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/transport/DP_20130306_144352.csv)

### Zdrowie
* [DP_20130306_144435.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zdrowie/DP_20130306_144435.csv)

### Żywność i napoje bez alkoholowe
* [DP_20130306_144609.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144609.csv)
* [DP_20130306_144715.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144715.csv)
* [DP_20130306_144850.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144850.csv)
* [DP_20130306_144906.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144906.csv)
* [DP_20130306_145020.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_145020.csv)
* [DP_20130306_145024.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_145024.csv)
* [DP_20130306_145111.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_145111.csv)

### Inne
* [DP_20130306_143448.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/inne/DP_20130306_143448.csv)

Całkowita liczba rekordów 50200.

## Przykładowy JSON
```json
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 1999,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 1.94
}
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 2000,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 2.64
}
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 2001,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 3.53
}
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 2002,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 3.16
}
```

# Agregację

## Import Danych

Impotujemy baze cen do mongoDB
```bash
mongoimport --db Ceny --collection Prices --type json --file Ceny.json
```

## Agregację C♯

Do agregacji użyłem drivera dla C# i bazy mongoDB.

Na poczatku musimy jakoś podłaczyć się do naszej bazy danych:

```c#
var client = new MongoClient("mongodb://localhost");
var server = client.GetServer();
```

Nastepnie podłanczamy sie pod kolekcje ktorej chcemy używać, w moim przypadku jest to kolekcja Cen rowarów i usług

```c#
var database = server.GetDatabase("Ceny");
var collection = database.GetCollection<Product>("Prices");
```

Teraz jak już jestemy połączeni to możemy zacząć zabawę z agregacjami.

Agregacja ta pokazuje jak ceny produktów zmieniały sie na przestrzeni lat w polskich województwach.
```c#
var priceFluctuation = new BsonDocument
                {
                    { "$project", new BsonDocument
                            {
                                { "towar", 1 },
                                { "cena", 1 },
                                { "rok", 1},
                                { "region", 1}
                            }
                    },
                    { "$group", new BsonDocument
                        {
                            { "_id", new BsonDocument
                                {
                                    { "product", "$towar"},
                                    { "region", "$region"}
                                }
                            },
                            { "values", new BsonDocument
                                {
                                    { "$addToSet", new BsonDocument
                                        {
                                            { "year", "$rok" },
                                            { "price", "$cena"}
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
```

Ta agregacja pokazuje średnią cen w roku w danym województwie.
```c#
var regionAveragePrice = new BsonDocument
                {
                    { "$project", new BsonDocument
                        {
                            { "cena", 1 },
                            { "rok", 1 },
                            { "region", 1 },
                        }
                    },
                    { "$group", new BsonDocument
                        {
                            { "_id", new BsonDocument
                                {
                                    { "region", "$region"},
                                    { "year", "$rok"}
                                }
                            },
                            { "value", new BsonDocument
                                {
                                    { "$avg", "$cena"}
                                }
                            }
                        }
                    }
                };
```

Gdy juz mamy swoje agregację teraz wystarczy wrzucić je na pipeline i ja odpalić. Możemy wrzucić kilka agregacji na pipeline, wtedy po skonczonej pierwszej agregacji,
dane z niej przejda do drugiej gdzie będą obrobione. Ja napisałem pojedyncze agregację tak by nie potrzebowaly dodatkowej obróbki.
```c#
var pipeline = new[] { regionAveragePrice };
var result = collection.Aggregate(pipeline);
```

Teraz nasze wyniki rezyduja w zmiennej result, dojsc do nich mozemy przez result.ResultDocuments, jest to kolekcja zwierajaca rekordy z naszej agregacji.

### Wynik Agregacji - Ceny towarów na przestrzeni lat

Fragment z 5106 rekordów.
```json
 {
     "_id": 
	 {
         "product": "jaja kurze spożywcze",
         "region": "POMORSKIE"
     },
     "values": [
		 {
             "year": 2010,
             "price": 0.19
         },
		 {
             "year": 2008,
             "price": 0.31
         },
		 {
             "year": 2011,
             "price": 0.18
         },
		 {
             "year": 2006,
             "price": 0.27
         },
		 {
             "year": 2005,
             "price": 0.22
         },
		 {
             "year": 2007,
             "price": 0.29
         },
		 {
             "year": 2004,
             "price": 0.25
         },
		 {
             "year": 2009,
             "price": 0.26
         },
		 {
             "year": 2003,
             "price": 0.23
         }
     ]
 } 
```

### Wynik Agregacji - Średnia Cena w Regionach na przestrzeni lat

Fragment z 299 rekordów.
```json
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2009 }, "value" : 242.87540909090922 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2008 }, "value" : 245.69644144144152 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2006 }, "value" : 253.01964757709249 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2005 }, "value" : 210.08896551724132 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2003 }, "value" : 159.13649789029543 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2002 }, "value" : 5.1289473684210529 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 1999 }, "value" : 4.766578947368421 }
{ "_id" : { "region" : "POMORSKIE", "year" : 2010 }, "value" : 217.01894009216582 }
{ "_id" : { "region" : "POMORSKIE", "year" : 2008 }, "value" : 212.82599099099116 }
{ "_id" : { "region" : "POMORSKIE", "year" : 2007 }, "value" : 202.14066964285715 }
```

### Wykres zamina cen Chleba i Ryżu w województwie Pomorskim

![chleb i ryz](https://raw.github.com/nosql/data-refine/master/images/lwasak_aggr.png)

* [Link do pliku źródłowego](/scripts/c%23/lwasak_ceny_agg.cs)


## Linki

* [JSON z danymi](https://dl.dropboxusercontent.com/u/634385/ceny-towarow-i-uslug.json)
* [Historia transformacji](http://dl.dropbox.com/u/44655481/Data/Transformations.json)

