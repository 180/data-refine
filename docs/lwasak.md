# Ceny Towarów i Usług - Łukasz Wasak

Dane pobrane z [GUS](http://www.stat.gov.pl/bdl/app/strona.html?p_name=indeks), użyto 32 zestawów danych:

## Towary nie kompsumcyjne
* [DP_20130306_142707.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_142707.csv)
* [DP_20130306_142807.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_142807.csv)
* [DP_20130306_142852.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_142852.csv)
* [DP_20130306_143019.csv](http://dl.dropbox.com/u/44655481/Data/nie%20kompsumcyjne/DP_20130306_143019.csv)

## Rolnictwo
* [DP_20130306_145335.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145335.csv)
* [DP_20130306_145426.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145426.csv)
* [DP_20130306_145526.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145526.csv)
* [DP_20130306_145607.csv](http://dl.dropbox.com/u/44655481/Data/rolnictwo/DP_20130306_145607.csv)

## Towary spożywcze

### Przetwory
* [DP_20130306_133022.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/przetwory/DP_20130306_133022.csv)

### Tłuszcze i nabiał
* [DP_20130306_132715.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/t%C5%82uszcze%20i%20nabia%C5%82/DP_20130306_132715.csv)
* [DP_20130306_132715.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/t%C5%82uszcze%20i%20nabia%C5%82/DP_20130306_132715.csv)

### Wyroby mięsne
* [DP_20130306_133300.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/miesne/DP_20130306_133300.csv)
* [DP_20130306_133435.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/miesne/DP_20130306_133435.csv)

### Zbożowe
* [DP_20130306_133826.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/zbozowe/DP_20130306_133826.csv)

### Pozostałe
* [DP_20130306_133619.csv](http://dl.dropbox.com/u/44655481/Data/spozywcze/zbozowe/DP_20130306_133619.csv)

## Towary i usługi kompsumcyjne
### Mieszkanie
* [DP_20130306_143621.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/mieszkanie/DP_20130306_143621.csv)
* [DP_20130306_143713.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/mieszkanie/DP_20130306_143713.csv)
* [DP_20130306_143756.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/mieszkanie/DP_20130306_143756.csv)

### Napoje alkoholowe i tytoń
* [DP_20130306_143908.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/napoje%20alkoholowe%20i%20tyton/DP_20130306_143908.csv)

### Odzież i obuwie
* [DP_20130306_144042.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/odziez%20i%20obuwie/DP_20130306_144042.csv)
* [DP_20130306_144145.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/odziez%20i%20obuwie/DP_20130306_144145.csv)

### Rekreacja i kultura
* [DP_20130306_144249.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/rekreacja%20i%20kultura/DP_20130306_144249.csv)

### Transport
* [DP_20130306_144352.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/transport/DP_20130306_144352.csv)

### Zdrowie
* [DP_20130306_144435.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zdrowie/DP_20130306_144435.csv)

### Żywność i napoje bez alkoholowe
* [DP_20130306_144609.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144609.csv)
* [DP_20130306_144715.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144715.csv)
* [DP_20130306_144850.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144850.csv)
* [DP_20130306_144906.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_144906.csv)
* [DP_20130306_145020.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_145020.csv)
* [DP_20130306_145024.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_145024.csv)
* [DP_20130306_145111.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/zywnosc%20i%20napoje%20bez%20alkoholowe/DP_20130306_145111.csv)

### Inne
* [DP_20130306_143448.csv](http://dl.dropbox.com/u/44655481/Data/towary%20i%20ulugi%20kompsumcyjne/inne/DP_20130306_143448.csv)

Całkowita liczba rekordów 50200.

## Przykładowy JSON
```json
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 1999,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 1.94
}
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 2000,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 2.64
}
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 2001,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 3.53
}
{
    "towar": "słonina",
    "ilosc": 1,
    "jednostka_miary": "kg",
    "rok": 2002,
    "waluta": "zł",
    "region": "POLSKA",
    "cena": 3.16
}
```

# Agregację

## Import Danych

Impotujemy baze cen do mongoDB
```bash
mongoimport --db Ceny --collection Prices --type json --file Ceny.json
```

## Agregację C♯

Do agregacji użyłem drivera dla C# i bazy mongoDB.

Na poczatku musimy jakoś podłaczyć się do naszej bazy danych:

```c#
var client = new MongoClient("mongodb://localhost");
var server = client.GetServer();
```

Nastepnie podłanczamy sie pod kolekcje ktorej chcemy używać, w moim przypadku jest to kolekcja Cen rowarów i usług

```c#
var database = server.GetDatabase("Ceny");
var collection = database.GetCollection<Product>("Prices");
```

Teraz jak już jestemy połączeni to możemy zacząć zabawę z agregacjami.

Agregacja ta pokazuje jak ceny produktów zmieniały sie na przestrzeni lat w polskich województwach.
```c#
var priceFluctuation = new BsonDocument
                {
                    { "$project", new BsonDocument
                            {
                                { "towar", 1 },
                                { "cena", 1 },
                                { "rok", 1},
                                { "region", 1}
                            }
                    },
                    { "$group", new BsonDocument
                        {
                            { "_id", new BsonDocument
                                {
                                    { "product", "$towar"},
                                    { "region", "$region"}
                                }
                            },
                            { "values", new BsonDocument
                                {
                                    { "$addToSet", new BsonDocument
                                        {
                                            { "year", "$rok" },
                                            { "price", "$cena"}
                                        }
                                    }
                                }
                            }
                        }
                    }
                };
```

Ta agregacja pokazuje średnią cen w roku w danym województwie.
```c#
var regionAveragePrice = new BsonDocument
                {
                    { "$project", new BsonDocument
                        {
                            { "cena", 1 },
                            { "rok", 1 },
                            { "region", 1 },
                        }
                    },
                    { "$group", new BsonDocument
                        {
                            { "_id", new BsonDocument
                                {
                                    { "region", "$region"},
                                    { "year", "$rok"}
                                }
                            },
                            { "value", new BsonDocument
                                {
                                    { "$avg", "$cena"}
                                }
                            }
                        }
                    }
                };
```

Gdy juz mamy swoje agregację teraz wystarczy wrzucić je na pipeline i ja odpalić. Możemy wrzucić kilka agregacji na pipeline, wtedy po skonczonej pierwszej agregacji,
dane z niej przejda do drugiej gdzie będą obrobione. Ja napisałem pojedyncze agregację tak by nie potrzebowaly dodatkowej obróbki.
```c#
var pipeline = new[] { regionAveragePrice };
var result = collection.Aggregate(pipeline);
```

Teraz nasze wyniki rezyduja w zmiennej result, dojsc do nich mozemy przez result.ResultDocuments, jest to kolekcja zwierajaca rekordy z naszej agregacji.

### Wynik Agregacji - Ceny towarów na przestrzeni lat

Fragment z 5106 rekordów.
```json
 {
     "_id": 
	 {
         "product": "jaja kurze spożywcze",
         "region": "POMORSKIE"
     },
     "values": [
		 {
             "year": 2010,
             "price": 0.19
         },
		 {
             "year": 2008,
             "price": 0.31
         },
		 {
             "year": 2011,
             "price": 0.18
         },
		 {
             "year": 2006,
             "price": 0.27
         },
		 {
             "year": 2005,
             "price": 0.22
         },
		 {
             "year": 2007,
             "price": 0.29
         },
		 {
             "year": 2004,
             "price": 0.25
         },
		 {
             "year": 2009,
             "price": 0.26
         },
		 {
             "year": 2003,
             "price": 0.23
         }
     ]
 } 
```

### Wynik Agregacji - Średnia Cena w Regionach na przestrzeni lat

Fragment z 299 rekordów.
```json
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2009 }, "value" : 242.87540909090922 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2008 }, "value" : 245.69644144144152 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2006 }, "value" : 253.01964757709249 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2005 }, "value" : 210.08896551724132 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2003 }, "value" : 159.13649789029543 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 2002 }, "value" : 5.1289473684210529 }
{ "_id" : { "region" : "WARMIŃSKO-MAZURSKIE", "year" : 1999 }, "value" : 4.766578947368421 }
{ "_id" : { "region" : "POMORSKIE", "year" : 2010 }, "value" : 217.01894009216582 }
{ "_id" : { "region" : "POMORSKIE", "year" : 2008 }, "value" : 212.82599099099116 }
{ "_id" : { "region" : "POMORSKIE", "year" : 2007 }, "value" : 202.14066964285715 }
```

<svg width="800" height="250"><g transform="translate(0, 250)"><path id="lcline" d="M50,-108.2L113.63636363636364,-115.1L177.27272727272728,-113.9L240.9090909090909,-113.60000000000001L304.54545454545456,-116.3L368.1818181818182,-107.30000000000001L431.8181818181818,-117.2L495.45454545454544,-129.5L559.0909090909091,-145.1L622.7272727272727,-146.60000000000002L686.3636363636364,-146L750,-156.8"></path><line x1="50" y1="-45" x2="750" y2="-45"></line><line x1="45" y1="-50" x2="45" y2="-200"></line><text class="xLabel" x="37.5" y="-20" text-anhor="middle">2000</text><text class="xLabel" x="101.13636363636364" y="-20" text-anhor="middle">2001</text><text class="xLabel" x="164.77272727272728" y="-20" text-anhor="middle">2002</text><text class="xLabel" x="228.4090909090909" y="-20" text-anhor="middle">2003</text><text class="xLabel" x="292.04545454545456" y="-20" text-anhor="middle">2004</text><text class="xLabel" x="355.6818181818182" y="-20" text-anhor="middle">2005</text><text class="xLabel" x="419.3181818181818" y="-20" text-anhor="middle">2006</text><text class="xLabel" x="482.95454545454544" y="-20" text-anhor="middle">2007</text><text class="xLabel" x="546.5909090909091" y="-20" text-anhor="middle">2008</text><text class="xLabel" x="610.2272727272727" y="-20" text-anhor="middle">2009</text><text class="xLabel" x="673.8636363636364" y="-20" text-anhor="middle">2010</text><text class="xLabel" x="737.5" y="-20" text-anhor="middle">2011</text><text class="yLabel" x="0" y="-50" text-anhor="right" dy="4">0</text><text class="yLabel" x="0" y="-80" text-anhor="right" dy="4">1</text><text class="yLabel" x="0" y="-110" text-anhor="right" dy="4">2</text><text class="yLabel" x="0" y="-140" text-anhor="right" dy="4">3</text><text class="yLabel" x="0" y="-170" text-anhor="right" dy="4">4</text><text class="yLabel" x="0" y="-200" text-anhor="right" dy="4">5</text><line class="xTicks" x1="50" y1="-45" x2="50" y2="-36"></line><line class="xTicks" x1="113.63636363636364" y1="-45" x2="113.63636363636364" y2="-36"></line><line class="xTicks" x1="177.27272727272728" y1="-45" x2="177.27272727272728" y2="-36"></line><line class="xTicks" x1="240.9090909090909" y1="-45" x2="240.9090909090909" y2="-36"></line><line class="xTicks" x1="304.54545454545456" y1="-45" x2="304.54545454545456" y2="-36"></line><line class="xTicks" x1="368.1818181818182" y1="-45" x2="368.1818181818182" y2="-36"></line><line class="xTicks" x1="431.8181818181818" y1="-45" x2="431.8181818181818" y2="-36"></line><line class="xTicks" x1="495.45454545454544" y1="-45" x2="495.45454545454544" y2="-36"></line><line class="xTicks" x1="559.0909090909091" y1="-45" x2="559.0909090909091" y2="-36"></line><line class="xTicks" x1="622.7272727272727" y1="-45" x2="622.7272727272727" y2="-36"></line><line class="xTicks" x1="686.3636363636364" y1="-45" x2="686.3636363636364" y2="-36"></line><line class="xTicks" x1="750" y1="-45" x2="750" y2="-36"></line><line class="yTicks" x1="30.909090909093802" y1="-50" x2="45" y2="-50"></line><line class="yTicks" x1="30.909090909093802" y1="-80" x2="45" y2="-80"></line><line class="yTicks" x1="30.909090909093802" y1="-110" x2="45" y2="-110"></line><line class="yTicks" x1="30.909090909093802" y1="-140" x2="45" y2="-140"></line><line class="yTicks" x1="30.909090909093802" y1="-170" x2="45" y2="-170"></line><line class="yTicks" x1="30.909090909093802" y1="-200" x2="45" y2="-200"></line><circle class="point" id="0" r="4" fill="red" stroke="white" stroke-width="2" cx="50" cy="-108.2"></circle><circle class="point" id="1" r="4" fill="red" stroke="white" stroke-width="2" cx="113.63636363636364" cy="-115.1"></circle><circle class="point" id="2" r="4" fill="red" stroke="white" stroke-width="2" cx="177.27272727272728" cy="-113.9"></circle><circle class="point" id="3" r="4" fill="red" stroke="white" stroke-width="2" cx="240.9090909090909" cy="-113.60000000000001"></circle><circle class="point" id="4" r="4" fill="red" stroke="white" stroke-width="2" cx="304.54545454545456" cy="-116.3"></circle><circle class="point" id="5" r="4" fill="red" stroke="white" stroke-width="2" cx="368.1818181818182" cy="-107.30000000000001"></circle><circle class="point" id="6" r="4" fill="red" stroke="white" stroke-width="2" cx="431.8181818181818" cy="-117.2"></circle><circle class="point" id="7" r="4" fill="red" stroke="white" stroke-width="2" cx="495.45454545454544" cy="-129.5"></circle><circle class="point" id="8" r="4" fill="red" stroke="white" stroke-width="2" cx="559.0909090909091" cy="-145.1"></circle><circle class="point" id="9" r="4" fill="red" stroke="white" stroke-width="2" cx="622.7272727272727" cy="-146.60000000000002"></circle><circle class="point" id="10" r="4" fill="red" stroke="white" stroke-width="2" cx="686.3636363636364" cy="-146"></circle><circle class="point" id="11" r="4" fill="red" stroke="white" stroke-width="2" cx="750" cy="-156.8"></circle><text class="pLabel" id="pl0" x="50" y="-128.2" text-anhor="middle" style="display: none;">1.94</text><text class="pLabel" id="pl1" x="113.63636363636364" y="-135.1" text-anhor="middle" style="display: none;">2.17</text><text class="pLabel" id="pl2" x="177.27272727272728" y="-133.9" text-anhor="middle" style="display: none;">2.13</text><text class="pLabel" id="pl3" x="240.9090909090909" y="-133.60000000000002" text-anhor="middle" style="display: none;">2.12</text><text class="pLabel" id="pl4" x="304.54545454545456" y="-136.3" text-anhor="middle" style="display: none;">2.21</text><text class="pLabel" id="pl5" x="368.1818181818182" y="-127.30000000000001" text-anhor="middle" style="display: none;">1.91</text><text class="pLabel" id="pl6" x="431.8181818181818" y="-137.2" text-anhor="middle" style="display: none;">2.24</text><text class="pLabel" id="pl7" x="495.45454545454544" y="-149.5" text-anhor="middle" style="display: none;">2.65</text><text class="pLabel" id="pl8" x="559.0909090909091" y="-165.1" text-anhor="middle" style="display: none;">3.17</text><text class="pLabel" id="pl9" x="622.7272727272727" y="-166.60000000000002" text-anhor="middle" style="display: none;">3.22</text><text class="pLabel" id="pl10" x="686.3636363636364" y="-166" text-anhor="middle" style="display: none;">3.2</text><text class="pLabel" id="pl11" x="750" y="-176.8" text-anhor="middle" style="display: none;">3.56</text><text id="mLabel" x="400" y="-225" text-anhor="middle">Ceny chleba w przeciagu lat</text></g></svg>

* [Link do pliku źródłowego](/scripts/c%23/lwasak_ceny_agg.cs)


## Linki

* [JSON z danymi](http://dl.dropbox.com/u/44655481/Data/Ceny.json)
* [Historia transformacji](http://dl.dropbox.com/u/44655481/Data/Transformations.json)

